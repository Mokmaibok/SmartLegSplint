<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Smart Leg Splint</title>
  <!-- Add viewport meta tag for responsive design -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Include Bootstrap 5 CSS -->
  <link rel="stylesheet" type="text/css" href="./css/bootstrap.min.css">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <!-- Navbar Brand -->
      <a class="navbar-brand" href="index.html">Smart Leg Splint</a>
      <!-- Navbar Toggler (for mobile menu) -->
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <!-- Navbar Menu Items -->
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="index.html">Home</a>
          </li>
          <li class="nav-item dropdown">
            <!-- Dropdown for setting menu -->
            <a class="nav-link dropdown-toggle" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Setting</a>
            <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
              <li><a class="dropdown-item" href="setting_shin.html">Shin Position</a></li>
              <li><a class="dropdown-item" href="setting_sole.html">Sole Position</a></li>
              <li><a class="dropdown-item" href="setting_instep.html">Instep Position</a></li>
            </ul>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="about.html">About</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="container" style="margin: auto;">
    <h1 class="mt-3">Shin Position</h1>
    <div class="row">
      <div class="col-md-4">
        <!-- Setpoint Form Card -->
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">Setpoint</h5>
            <form id="setpointForm">
              <div class="form-group">
                <p class="card-text">Current Setpoint: <span id="Setpoint_1">-</span> °C</p>
                <input type="number" step="0.1" class="form-control" id="setpointInput_1" placeholder="Enter Setpoint">
              </div>
              <button type="submit" class="btn btn-primary" style="margin-top: 10px; width: 100%;">Update Setpoint</button>
            </form>
          </div>
        </div>
        <!-- Setpoint Timer Card -->
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">Set Timer</h5>
            <form id="timerForm">
              <div class="form-group">
                <p class="card-text">Current Timer: <span id="Timer_1">-</span> Minute</p>
                <input type="number" step="0.1" class="form-control" id="timerInput_1" placeholder="Enter Minute">
              </div>
              <button type="submit" class="btn btn-primary" style="margin-top: 10px; width: 100%;">Set Timer</button>
            </form>
          </div>
        </div>
        <!-- Heater Control Card -->
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">Heater Control</h5>
			      <p>Status: <span id="heaterStatus_1">-</span></p>
            <div class="row">
              <button type="button" class="btn btn-success" style="width: 50%;" onclick="startHeater_1()">Start</button>
              <button type="button" class="btn btn-danger" style="width: 50%;" onclick="stopHeater_1()">Stop</button>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-6">
            <!-- Temperature In Card -->
            <div class="card mb-3">
              <div class="card-body">
                <h5 class="card-title">Inner Temperature</h5>
                <p class="card-text">Current Temperature: <span id="temp_in_1">-</span> °C</p>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <!-- Temperature Out Card -->
            <div class="card mb-3">
              <div class="card-body">
                <h5 class="card-title">Outer Temperature</h5>
                <p class="card-text">Current Temperature: <span id="temp_out_1">-</span> °C</p>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <!-- Humidity Card -->
            <div class="card mb-3">
              <div class="card-body">
                <h5 class="card-title">Inner Humidity</h5>
                <p class="card-text">Current Humidity: <span id="humidity_in_1">-</span> %</p>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <!-- Heater Output Card -->
            <div class="card mb-3">
              <div class="card-body">
                <h5 class="card-title">Heater Output</h5>
                <p class="card-text">Current Heater Output: <span id="heater_1">-</span> %</p>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <!-- Countdown Timer Card -->
            <div class="card mb-3">
              <div class="card-body">
                <h5 class="card-title">Countdown Timer</h5>
                <p>Time Remaining: <span id="minute_1">-</span> Minute <span id="second_1">-</span> Second</p>
                <!-- Timer Modal -->
                <div class="modal fade" id="timerModal" tabindex="-1" aria-labelledby="timerModalLabel" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="timerModalLabel">Timer Expired</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        The timer has expired. Heater has been stopped.
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Temperature Chart Card -->
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">Inner Temperature</h5>
            <canvas id="temperatureChartShin" style="height: 300px; max-height: 300px;"></canvas>
          </div>
        </div>
        <!-- Temperature In - Out Chart Card -->
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">Inner and Outer Temperature</h5>
            <canvas id="temperatureInOutChartShin" style="height: 300px; max-height: 300px;"></canvas>
          </div>
        </div>
        <!-- Humidity Chart Card -->
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">Inner Humidity</h5>
            <canvas id="humidityChartShin" style="height: 300px; max-height: 300px;"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="./js/main.js"></script>
  <script src="./js/jquery.min.js"></script>
  <script src="./js/bootstrap.min.js"></script>
  <script src="./js/bootstrap.bundle.min.js"></script>
  <script src="./js/chart.min.js"></script>
  <script>
    function updateData() {
      fetch('/data')
        .then(response => response.json())
        .then(data => {
          updatetemperatureChartShin(data);
          updatetemperatureInOutChartShin(data);
          updatehumidityChartShin(data);
        });
    }
    setInterval(updateData, 5000);
    
    function updateSetpointValue(setpoint_1) {
      document.getElementById('setpointInput_1').value = setpoint_1.toFixed(2);
    }
  
    document.getElementById('setpointForm').addEventListener('submit', function(event) {
      event.preventDefault();
      var setpoint_1 = parseFloat(document.getElementById('setpointInput_1').value);
      if (!isNaN(setpoint_1)) {
        updateSetpoint(setpoint_1);
      } else {
        alert('Invalid Setpoint value');
      }
    });

    function updateSetpoint(setpoint_1) {
      var formData = new FormData();
      formData.append('setpoint_1', setpoint_1);
      fetch('/setpoint_1', {
        method: 'POST',
        body: formData
      })
      .then(function(response) {
        return response.text();
      })
      .then(function(message) {
        console.log(message);
        updateSetpointValue(setpoint_1);
      })
      .catch(function(error) {
        console.error('Error:', error);
      });
    }

    function updateTimerValue(minute_1) {
      document.getElementById('timerInput_1').value = minute_1;
    }
  
    document.getElementById('timerForm').addEventListener('submit', function(event) {
      event.preventDefault();
      var minute_1 = parseFloat(document.getElementById('timerInput_1').value);
      if (!isNaN(minute_1)) {
        updateTimer(minute_1);
      } else {
        alert('Invalid Timer value');
      }
    });

    function updateTimer(minute_1) {
      var formData = new FormData();
      formData.append('minute_1', minute_1);
      fetch('/minute_1', {
        method: 'POST',
        body: formData
      })
      .then(function(response) {
        return response.text();
      })
      .then(function(message) {
        console.log(message);
        updateTimerValue(minute_1);
      })
      .catch(function(error) {
        console.error('Error:', error);
      });
    }

    var ctxTemperature = document.getElementById('temperatureChartShin').getContext('2d');
    var dataTemperature = {
      labels: [],
      datasets: [
        {
          label: 'Inner Temperature (°C)',
          borderColor: 'rgb(100, 221, 23)',
          data: [],
          fill: false
        },
        {
          label: 'Setpoint (°C)',
          borderColor: 'rgb(198, 40, 40)',
          data: [],
          fill: false
        }
      ]
    };
    var optionsTemperature = {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          display: true,
          title: {
            display: true,
            text: 'Time'
          },
          ticks: {
            maxTicksLimit: 20
          }
        },
        y: {
          display: true,
          title: {
            display: true,
            text: 'Temperature (°C)'
          },
          suggestedMin: 15,
          suggestedMax: 40
        }
      }
    };
    var temperatureChartShin = new Chart(ctxTemperature, {
      type: 'line',
      data: dataTemperature,
      options: optionsTemperature
    });

    function updatetemperatureChartShin(data) {
      var time = new Date().toLocaleTimeString();
      temperatureChartShin.data.labels.push(time);
      temperatureChartShin.data.datasets[0].data.push(data.temp_in_1.toFixed(2));
      temperatureChartShin.data.datasets[1].data.push(data.setpoint_1.toFixed(2));
      
      // Limit the chart data length to prevent it from becoming too long
      if (temperatureChartShin.data.labels.length > 20) {
        temperatureChartShin.data.labels.shift();
        temperatureChartShin.data.datasets[0].data.shift();
        temperatureChartShin.data.datasets[1].data.shift();
      }
      
      // Update the chart
      temperatureChartShin.update();

      // Store the chart data in Local Storage
      localStorage.setItem('temperatureChartShinLabels', JSON.stringify(temperatureChartShin.data.labels));
      localStorage.setItem('temperatureChartShinData1', JSON.stringify(temperatureChartShin.data.datasets[0].data));
      localStorage.setItem('temperatureChartShinData2', JSON.stringify(temperatureChartShin.data.datasets[1].data));
    }

    // Load the stored chart data from Local Storage when the page loads
    document.addEventListener('DOMContentLoaded', function() {
      var storedLabels = localStorage.getItem('temperatureChartShinLabels');
      var storedData1 = localStorage.getItem('temperatureChartShinData1');
      var storedData2 = localStorage.getItem('temperatureChartShinData2');
      
      if (storedLabels && storedData1 && storedData2) {
        temperatureChartShin.data.labels = JSON.parse(storedLabels);
        temperatureChartShin.data.datasets[0].data = JSON.parse(storedData1);
        temperatureChartShin.data.datasets[1].data = JSON.parse(storedData2);
        
        temperatureChartShin.update();
      }
    });

    var ctxTemperatureInOut = document.getElementById('temperatureInOutChartShin').getContext('2d');
    var dataTemperatureInOut = {
      labels: [],
      datasets: [
        {
          label: 'Inner Temperature (°C)',
          borderColor: 'rgb(100, 221, 23)',
          data: [],
          fill: false
        },
        {
          label: 'Outer Temperature (°C)',
          borderColor: 'rgb(255, 234, 0)',
          data: [],
          fill: false
        }
      ]
    };
    var optionsTemperatureInOut = {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          display: true,
          title: {
            display: true,
            text: 'Time'
          },
          ticks: {
            maxTicksLimit: 20
          }
        },
        y: {
          display: true,
          title: {
            display: true,
            text: 'Temperature (°C)'
          },
          suggestedMin: 15,
          suggestedMax: 40
        }
      }
    };
    var temperatureInOutChartShin = new Chart(ctxTemperatureInOut, {
      type: 'line',
      data: dataTemperatureInOut,
      options: optionsTemperatureInOut
    });

    function updatetemperatureInOutChartShin(data) {
      var time = new Date().toLocaleTimeString();
      temperatureInOutChartShin.data.labels.push(time);
      temperatureInOutChartShin.data.datasets[0].data.push(data.temp_in_1.toFixed(2));
      temperatureInOutChartShin.data.datasets[1].data.push(data.temp_out_1.toFixed(2));
      
      // Limit the chart data length to prevent it from becoming too long
      if (temperatureInOutChartShin.data.labels.length > 20) {
        temperatureInOutChartShin.data.labels.shift();
        temperatureInOutChartShin.data.datasets[0].data.shift();
        temperatureInOutChartShin.data.datasets[1].data.shift();
      }
      
      // Update the chart
      temperatureInOutChartShin.update();

      // Store the chart data in Local Storage
      localStorage.setItem('temperatureInOutChartShinLabels', JSON.stringify(temperatureInOutChartShin.data.labels));
      localStorage.setItem('temperatureInOutChartShinData1', JSON.stringify(temperatureInOutChartShin.data.datasets[0].data));
      localStorage.setItem('temperatureInOutChartShinData2', JSON.stringify(temperatureInOutChartShin.data.datasets[1].data));
    }

    // Load the stored chart data from Local Storage when the page loads
    document.addEventListener('DOMContentLoaded', function() {
      var storedLabels = localStorage.getItem('temperatureInOutChartShinLabels');
      var storedData1 = localStorage.getItem('temperatureInOutChartShinData1');
      var storedData2 = localStorage.getItem('temperatureInOutChartShinData2');
      
      if (storedLabels && storedData1 && storedData2) {
        temperatureInOutChartShin.data.labels = JSON.parse(storedLabels);
        temperatureInOutChartShin.data.datasets[0].data = JSON.parse(storedData1);
        temperatureInOutChartShin.data.datasets[1].data = JSON.parse(storedData2);
        
        temperatureInOutChartShin.update();
      }
    });

    var ctxHumidity = document.getElementById('humidityChartShin').getContext('2d');
    var dataHumidity = {
      labels: [],
      datasets: [
        {
          label: 'Inner Humidity (%)',
          borderColor: 'rgb(2, 136, 209)',
          data: [],
          fill: false
        }
      ]
    };
    var optionsHumidity = {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          display: true,
          title: {
            display: true,
            text: 'Time'
          },
          ticks: {
            maxTicksLimit: 20
          }
        },
        y: {
          display: true,
          title: {
            display: true,
            text: 'Humidity (%)'
          },
          suggestedMin: 0,
          suggestedMax: 100
        }
      }
    };
    var humidityChartShin = new Chart(ctxHumidity, {
      type: 'line',
      data: dataHumidity,
      options: optionsHumidity
    });

    function updatehumidityChartShin(data) {
      var time = new Date().toLocaleTimeString();
      humidityChartShin.data.labels.push(time);
      humidityChartShin.data.datasets[0].data.push(data.humidity_in_1.toFixed(2));
      
      // Limit the chart data length to prevent it from becoming too long
      if (humidityChartShin.data.labels.length > 20) {
        humidityChartShin.data.labels.shift();
        humidityChartShin.data.datasets[0].data.shift();
      }
      
      // Update the chart
      humidityChartShin.update();

      // Store the chart data in Local Storage
      localStorage.setItem('humidityChartShinLabels', JSON.stringify(humidityChartShin.data.labels));
      localStorage.setItem('humidityChartShinData', JSON.stringify(humidityChartShin.data.datasets[0].data));
    }

    // Load the stored chart data from Local Storage when the page loads
    document.addEventListener('DOMContentLoaded', function() {
      var storedLabels = localStorage.getItem('humidityChartShinLabels');
      var storedData = localStorage.getItem('humidityChartShinData');
      
      if (storedLabels && storedData) {
        humidityChartShin.data.labels = JSON.parse(storedLabels);
        humidityChartShin.data.datasets[0].data = JSON.parse(storedData);
        
        humidityChartShin.update();
      }
    });

    // Function to reset all graphs
    function resetGraphs() {
      // Clear stored chart data in Local Storage
      localStorage.removeItem('temperatureChartShinLabels');
      localStorage.removeItem('temperatureChartShinData1');
      localStorage.removeItem('temperatureChartShinData2');
      localStorage.removeItem('temperatureInOutChartShinLabels');
      localStorage.removeItem('temperatureInOutChartShinData1');
      localStorage.removeItem('temperatureInOutChartShinData2');
      localStorage.removeItem('humidityChartShinLabels');
      localStorage.removeItem('humidityChartShinData');

      // Clear the data arrays in the charts
      temperatureChartShin.data.labels = [];
      temperatureChartShin.data.datasets[0].data = [];
      temperatureChartShin.data.datasets[1].data = [];
      temperatureChartShin.update();

      temperatureInOutChartShin.data.labels = [];
      temperatureInOutChartShin.data.datasets[0].data = [];
      temperatureInOutChartShin.data.datasets[1].data = [];
      temperatureInOutChartShin.update();

      humidityChartShin.data.labels = [];
      humidityChartShin.data.datasets[0].data = [];
      humidityChartShin.update();
    }

    let heaterStatus_1 = false;

    function startHeater_1() {
      if (heaterStatus_1) {
        console.log("Heater is already started.");
        return;
      }
      
      var minute_1 = parseFloat(document.getElementById('timerInput_1').value);
      
      if (!isNaN(minute_1) && minute_1 >= 0) {
        fetch('/start-heater_1', { method: 'POST' })
          .then(response => response.text())
          .then(message => {
            console.log(message);
            heaterStatus_1 = true;
          });
      } else {
        alert('Please enter a valid timer value greater than 0.');
      }
    }

    function stopHeater_1() {
      fetch('/stop-heater_1', { method: 'POST' })
        .then(response => response.text())
        .then(message => {
          console.log(message);
          heaterStatus_1 = false;
          resetGraphs();
        });
    }
  </script>
</body>
</html>
