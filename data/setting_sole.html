<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Smart Leg Splint</title>
  <!-- Add viewport meta tag for responsive design -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Include Bootstrap 5 CSS -->
  <link rel="stylesheet" type="text/css" href="./css/bootstrap.min.css">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <!-- Navbar Brand -->
      <a class="navbar-brand" href="index.html">Smart Leg Splint</a>
      <!-- Navbar Toggler (for mobile menu) -->
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <!-- Navbar Menu Items -->
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="index.html">Home</a>
          </li>
          <li class="nav-item dropdown">
            <!-- Dropdown for setting menu -->
            <a class="nav-link dropdown-toggle" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Setting</a>
            <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
              <li><a class="dropdown-item" href="setting_shin.html">Shin Position</a></li>
              <li><a class="dropdown-item" href="setting_sole.html">Sole Position</a></li>
              <li><a class="dropdown-item" href="setting_instep.html">Instep Position</a></li>
            </ul>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="about.html">About</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container" style="margin: auto;">
    <h1 class="mt-3">Sole Position</h1>
    <div class="row">
      <div class="col-md-4">
        <!-- Setpoint Form Card -->
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">Setpoint</h5>
            <form id="setpointForm">
              <div class="form-group">
                <p class="card-text">Current Setpoint: <span id="Setpoint_2">-</span> °C</p>
                <input type="number" step="0.1" class="form-control" id="setpointInput_2" placeholder="Enter Setpoint">
              </div>
              <button type="submit" class="btn btn-primary" style="margin-top: 10px; width: 100%;">Update Setpoint</button>
            </form>
          </div>
        </div>
        <!-- Setpoint Timer Card -->
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">Set Timer</h5>
            <form id="timerForm">
              <div class="form-group">
                <p class="card-text">Current Timer: <span id="Timer_2">-</span> Minute</p>
                <input type="number" step="0.1" class="form-control" id="timerInput_2" placeholder="Enter Minute">
              </div>
              <button type="submit" class="btn btn-primary" style="margin-top: 10px; width: 100%;">Set Timer</button>
            </form>
          </div>
        </div>
        <!-- Heater Control Card -->
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">Heater Control</h5>
            <p>Status: <span id="heaterStatus_2">-</span></p>
            <div class="row">
              <button type="button" class="btn btn-success" style="width: 50%;" onclick="startHeater_2()">Start</button>
              <button type="button" class="btn btn-danger" style="width: 50%;" onclick="stopHeater_2()">Stop</button>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-6">
            <!-- Temperature In Card -->
            <div class="card mb-3">
              <div class="card-body">
                <h5 class="card-title">Inner Temperature</h5>
                <p class="card-text">Current Temperature: <span id="temp_in_2">-</span> °C</p>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <!-- Temperature Out Card -->
            <div class="card mb-3">
              <div class="card-body">
                <h5 class="card-title">Outer Temperature</h5>
                <p class="card-text">Current Temperature: <span id="temp_out_2">-</span> °C</p>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <!-- Humidity Card -->
            <div class="card mb-3">
              <div class="card-body">
                <h5 class="card-title">Inner Humidity</h5>
                <p class="card-text">Current Humidity: <span id="humidity_in_2">-</span> %</p>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <!-- Heater Output Card -->
            <div class="card mb-3">
              <div class="card-body">
                <h5 class="card-title">Heater Output</h5>
                <p class="card-text">Current Heater Output: <span id="heater_2">-</span> %</p>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <!-- Countdown Timer Card -->
            <div class="card mb-3">
              <div class="card-body">
                <h5 class="card-title">Countdown Timer</h5>
                <p>Time Remaining: <span id="minute_2">-</span> Minute <span id="second_2">-</span> Second</p>
                <!-- Timer Modal -->
                <div class="modal fade" id="timerModal" tabindex="-1" aria-labelledby="timerModalLabel" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="timerModalLabel">Timer Expired</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        The timer has expired. Heater has been stopped.
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Temperature Chart Card -->
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">Inner and Setpoint Temperature</h5>
            <canvas id="temperatureChartSole" style="height: 300px; max-height: 300px;"></canvas>
          </div>
        </div>
        <!-- Temperature In - Out Chart Card -->
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">Inner and Outer Temperature</h5>
            <canvas id="temperatureInOutChartSole" style="height: 300px; max-height: 300px;"></canvas>
          </div>
        </div>
        <!-- Humidity Chart Card -->
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">Inner Humidity</h5>
            <canvas id="humidityChartSole" style="height: 300px; max-height: 300px;"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="./js/main.js"></script>
  <script src="./js/jquery.min.js"></script>
  <script src="./js/bootstrap.min.js"></script>
  <script src="./js/bootstrap.bundle.min.js"></script>
  <script src="./js/chart.min.js"></script>
  <script>
    function updateValues(data) {
      document.getElementById('temp_in_2').innerText = data.temp_in_2.toFixed(2);
      document.getElementById('temp_out_2').innerText = data.temp_out_2.toFixed(2);
      document.getElementById('humidity_in_2').innerText = data.humidity_in_2.toFixed(2);
      document.getElementById('Setpoint_2').innerText = data.setpoint_2.toFixed(2);
      document.getElementById('Timer_2').innerText = data.minute_2;
      document.getElementById('heater_2').innerText = data.heater_2.toFixed(2);
      document.getElementById('minute_2').innerText = data.minute_2;
      document.getElementById('second_2').innerText = data.second_2;
      if (data.minute_2 === 0 && data.second_2 === 1) {
        $('#timerModal').modal('show');
        heaterStatus_2 = false;
      }

      if (!heaterStatus_2) {
        document.getElementById('heaterStatus_2').innerText = 'Stopped';
        document.getElementById('heaterStatus_2').style.color = 'red';
      } else {
        document.getElementById('heaterStatus_2').innerText = 'Started';
        document.getElementById('heaterStatus_2').style.color = 'green';
      }
    }
	
    // Connect to WebSocket
    var ws = new WebSocket('ws://' + window.location.hostname + ':81/');
    ws.onmessage = function(event) {
      var data = JSON.parse(event.data);
      updateValues(data);
    };
	
    function updateData() {
      fetch('/data')
        .then(response => response.json())
        .then(data => {
          updatetemperatureChartSole(data);
          updatetemperatureInOutChartSole(data);
          updatehumidityChartSole(data);
        });
    }
    setInterval(updateData, 5000);

    function updateSetpointValue(setpoint_2) {
      document.getElementById('setpointInput_2').value = setpoint_2.toFixed(2);
    }
  
    document.getElementById('setpointForm').addEventListener('submit', function(event) {
      event.preventDefault();
      var setpoint_2 = parseFloat(document.getElementById('setpointInput_2').value);
      if (!isNaN(setpoint_2)) {
        updateSetpoint(setpoint_2);
      } else {
        alert('Invalid Setpoint value');
      }
    });

    function updateSetpoint(setpoint_2) {
      var formData = new FormData();
      formData.append('setpoint_2', setpoint_2);
      fetch('/setpoint_2', {
        method: 'POST',
        body: formData
      })
      .then(function(response) {
        return response.text();
      })
      .then(function(message) {
        console.log(message);
        updateSetpointValue(setpoint_2);
      })
      .catch(function(error) {
        console.error('Error:', error);
      });
    }

    function updateTimerValue(minute_2) {
      document.getElementById('timerInput_2').value = minute_2;
    }
  
    document.getElementById('timerForm').addEventListener('submit', function(event) {
      event.preventDefault();
      var minute_2 = parseFloat(document.getElementById('timerInput_2').value);
      if (!isNaN(minute_2)) {
        updateTimer(minute_2);
      } else {
        alert('Invalid Timer value');
      }
    });

    function updateTimer(minute_2) {
      var formData = new FormData();
      formData.append('minute_2', minute_2);
      fetch('/minute_2', {
        method: 'POST',
        body: formData
      })
      .then(function(response) {
        return response.text();
      })
      .then(function(message) {
        console.log(message);
        updateTimerValue(minute_2);
      })
      .catch(function(error) {
        console.error('Error:', error);
      });
    }

    var ctxTemperature = document.getElementById('temperatureChartSole').getContext('2d');
    var dataTemperature = {
      labels: [],
      datasets: [
        {
          label: 'Inner Temperature (°C)',
          borderColor: 'rgb(100, 221, 23)',
          data: [],
          fill: false
        },
        {
          label: 'Setpoint (°C)',
          borderColor: 'rgb(198, 40, 40)',
          data: [],
          fill: false
        }
      ]
    };
    var optionsTemperature = {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          display: true,
          title: {
            display: true,
            text: 'Time'
          },
          ticks: {
            maxTicksLimit: 20
          }
        },
        y: {
          display: true,
          title: {
            display: true,
            text: 'Temperature (°C)'
          },
          suggestedMin: 15,
          suggestedMax: 40
        }
      }
    };
    var temperatureChartSole = new Chart(ctxTemperature, {
      type: 'line',
      data: dataTemperature,
      options: optionsTemperature
    });

    function updatetemperatureChartSole(data) {
      var time = new Date().toLocaleTimeString();
      temperatureChartSole.data.labels.push(time);
      temperatureChartSole.data.datasets[0].data.push(data.temp_in_2.toFixed(2));
      temperatureChartSole.data.datasets[1].data.push(data.setpoint_2.toFixed(2));
      
      // Limit the chart data length to prevent it from becoming too long
      if (temperatureChartSole.data.labels.length > 20) {
        temperatureChartSole.data.labels.shift();
        temperatureChartSole.data.datasets[0].data.shift();
        temperatureChartSole.data.datasets[1].data.shift();
      }
      
      // Update the chart
      temperatureChartSole.update();

      // Store the chart data in Local Storage
      localStorage.setItem('temperatureChartSoleLabels', JSON.stringify(temperatureChartSole.data.labels));
      localStorage.setItem('temperatureChartSoleData1', JSON.stringify(temperatureChartSole.data.datasets[0].data));
      localStorage.setItem('temperatureChartSoleData2', JSON.stringify(temperatureChartSole.data.datasets[1].data));
    }

    // Load the stored chart data from Local Storage when the page loads
    document.addEventListener('DOMContentLoaded', function() {
      var storedLabels = localStorage.getItem('temperatureChartSoleLabels');
      var storedData1 = localStorage.getItem('temperatureChartSoleData1');
      var storedData2 = localStorage.getItem('temperatureChartSoleData2');
      
      if (storedLabels && storedData1 && storedData2) {
        temperatureChartSole.data.labels = JSON.parse(storedLabels);
        temperatureChartSole.data.datasets[0].data = JSON.parse(storedData1);
        temperatureChartSole.data.datasets[1].data = JSON.parse(storedData2);
        
        temperatureChartSole.update();
      }
    });

    var ctxTemperatureInOut = document.getElementById('temperatureInOutChartSole').getContext('2d');
    var dataTemperatureInOut = {
      labels: [],
      datasets: [
        {
          label: 'Inner Temperature (°C)',
          borderColor: 'rgb(100, 221, 23)',
          data: [],
          fill: false
        },
        {
          label: 'Outer Temperature (°C)',
          borderColor: 'rgb(255, 234, 0)',
          data: [],
          fill: false
        }
      ]
    };
    var optionsTemperatureInOut = {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          display: true,
          title: {
            display: true,
            text: 'Time'
          },
          ticks: {
            maxTicksLimit: 20
          }
        },
        y: {
          display: true,
          title: {
            display: true,
            text: 'Temperature (°C)'
          },
          suggestedMin: 15,
          suggestedMax: 40
        }
      }
    };
    var temperatureInOutChartSole = new Chart(ctxTemperatureInOut, {
      type: 'line',
      data: dataTemperatureInOut,
      options: optionsTemperatureInOut
    });

    function updatetemperatureInOutChartSole(data) {
      var time = new Date().toLocaleTimeString();
      temperatureInOutChartSole.data.labels.push(time);
      temperatureInOutChartSole.data.datasets[0].data.push(data.temp_in_2.toFixed(2));
      temperatureInOutChartSole.data.datasets[1].data.push(data.temp_out_2.toFixed(2));
      
      // Limit the chart data length to prevent it from becoming too long
      if (temperatureInOutChartSole.data.labels.length > 20) {
        temperatureInOutChartSole.data.labels.shift();
        temperatureInOutChartSole.data.datasets[0].data.shift();
        temperatureInOutChartSole.data.datasets[1].data.shift();
      }
      
      // Update the chart
      temperatureInOutChartSole.update();

      // Store the chart data in Local Storage
      localStorage.setItem('temperatureInOutChartSoleLabels', JSON.stringify(temperatureInOutChartSole.data.labels));
      localStorage.setItem('temperatureInOutChartSoleData1', JSON.stringify(temperatureInOutChartSole.data.datasets[0].data));
      localStorage.setItem('temperatureInOutChartSoleData2', JSON.stringify(temperatureInOutChartSole.data.datasets[1].data));
    }

    // Load the stored chart data from Local Storage when the page loads
    document.addEventListener('DOMContentLoaded', function() {
      var storedLabels = localStorage.getItem('temperatureInOutChartSoleLabels');
      var storedData1 = localStorage.getItem('temperatureInOutChartSoleData1');
      var storedData2 = localStorage.getItem('temperatureInOutChartSoleData2');
      
      if (storedLabels && storedData1 && storedData2) {
        temperatureInOutChartSole.data.labels = JSON.parse(storedLabels);
        temperatureInOutChartSole.data.datasets[0].data = JSON.parse(storedData1);
        temperatureInOutChartSole.data.datasets[1].data = JSON.parse(storedData2);
        
        temperatureInOutChartSole.update();
      }
    });

    var ctxHumidity = document.getElementById('humidityChartSole').getContext('2d');
    var dataHumidity = {
      labels: [],
      datasets: [
        {
          label: 'Inner Humidity (%)',
          borderColor: 'rgb(2, 136, 209)',
          data: [],
          fill: false
        }
      ]
    };
    var optionsHumidity = {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          display: true,
          title: {
            display: true,
            text: 'Time'
          },
          ticks: {
            maxTicksLimit: 20
          }
        },
        y: {
          display: true,
          title: {
            display: true,
            text: 'Humidity (%)'
          },
          suggestedMin: 0,
          suggestedMax: 100
        }
      }
    };
    var humidityChartSole = new Chart(ctxHumidity, {
      type: 'line',
      data: dataHumidity,
      options: optionsHumidity
    });

    function updatehumidityChartSole(data) {
      var time = new Date().toLocaleTimeString();
      humidityChartSole.data.labels.push(time);
      humidityChartSole.data.datasets[0].data.push(data.humidity_in_2.toFixed(2));
      
      // Limit the chart data length to prevent it from becoming too long
      if (humidityChartSole.data.labels.length > 20) {
        humidityChartSole.data.labels.shift();
        humidityChartSole.data.datasets[0].data.shift();
      }
      
      // Update the chart
      humidityChartSole.update();

      // Store the chart data in Local Storage
      localStorage.setItem('humidityChartSoleLabels', JSON.stringify(humidityChartSole.data.labels));
      localStorage.setItem('humidityChartSoleData', JSON.stringify(humidityChartSole.data.datasets[0].data));
    }

    // Load the stored chart data from Local Storage when the page loads
    document.addEventListener('DOMContentLoaded', function() {
      var storedLabels = localStorage.getItem('humidityChartSoleLabels');
      var storedData = localStorage.getItem('humidityChartSoleData');
      
      if (storedLabels && storedData) {
        humidityChartSole.data.labels = JSON.parse(storedLabels);
        humidityChartSole.data.datasets[0].data = JSON.parse(storedData);
        
        humidityChartSole.update();
      }
    });

    // Function to reset all graphs
    function resetGraphs() {
      // Clear stored chart data in Local Storage
      localStorage.removeItem('temperatureChartSoleLabels');
      localStorage.removeItem('temperatureChartSoleData1');
      localStorage.removeItem('temperatureChartSoleData2');
      localStorage.removeItem('temperatureInOutChartSoleLabels');
      localStorage.removeItem('temperatureInOutChartSoleData1');
      localStorage.removeItem('temperatureInOutChartSoleData2');
      localStorage.removeItem('humidityChartSoleLabels');
      localStorage.removeItem('humidityChartSoleData');

      // Clear the data arrays in the charts
      temperatureChartSole.data.labels = [];
      temperatureChartSole.data.datasets[0].data = [];
      temperatureChartSole.data.datasets[1].data = [];
      temperatureChartSole.update();

      temperatureInOutChartSole.data.labels = [];
      temperatureInOutChartSole.data.datasets[0].data = [];
      temperatureInOutChartSole.data.datasets[1].data = [];
      temperatureInOutChartSole.update();

      humidityChartSole.data.labels = [];
      humidityChartSole.data.datasets[0].data = [];
      humidityChartSole.update();
    }

    let heaterStatus_2 = false;

    function startHeater_2() {
      if (heaterStatus_2) {
        console.log("Heater is already started.");
        return;
      }
      
      var minute_2 = parseFloat(document.getElementById('timerInput_2').value);
      
      if (!isNaN(minute_2) && minute_2 >= 0) {
        fetch('/start-heater_2', { method: 'POST' })
          .then(response => response.text())
          .then(message => {
            console.log(message);
            heaterStatus_2 = true;
          });
      } else {
        alert('Please enter a valid timer value greater than 0.');
      }
    }

    function stopHeater_2() {
      fetch('/stop-heater_2', { method: 'POST' })
        .then(response => response.text())
        .then(message => {
          console.log(message);
          heaterStatus_2 = false;
          resetGraphs();
        });
    }
  </script>
</body>
</html>
